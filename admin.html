<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nebesu Temizlik - Admin Panel</title>
    <link rel="icon" href="/logo.png" type="image/png">
    <link rel="stylesheet" href="styles.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            background: linear-gradient(135deg, #e0e7ff 0%, #f8fafc 100%);
            min-height: 100vh;
            font-family: 'Inter', 'Segoe UI', Arial, sans-serif;
            color: #222;
        }
        .admin-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }
        .admin-header {
            background: #6366f1;
            color: white;
            padding: 2rem;
            border-radius: 18px;
            margin-bottom: 2rem;
            box-shadow: 0 4px 24px rgba(99,102,241,0.12);
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        .admin-tabs {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
        }
        .admin-tab {
            padding: 1rem 2rem;
            background: #f3f4f6;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 600;
            font-size: 1.1rem;
            transition: all 0.3s;
            box-shadow: 0 2px 8px rgba(0,0,0,0.04);
        }
        .admin-tab.active {
            background: #6366f1;
            color: white;
            box-shadow: 0 4px 16px rgba(99,102,241,0.12);
        }
        .admin-content {
            display: none;
        }
        .admin-content.active {
            display: block;
        }
        .reviews-filters {
            margin-bottom: 2rem;
            display: flex;
            gap: 1rem;
            align-items: center;
        }
        .reviews-filters select, .reviews-filters input {
            padding: 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 10px;
            font-size: 1rem;
            background: #f3f4f6;
            transition: border-color 0.2s;
        }
        .reviews-filters select:focus, .reviews-filters input:focus {
            border-color: #6366f1;
            outline: none;
        }
        .reviews-filters button {
            padding: 0.75rem 1.5rem;
            background: #6366f1;
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            box-shadow: 0 2px 8px rgba(99,102,241,0.08);
            transition: background 0.2s;
        }
        .reviews-filters button:hover {
            background: #4338ca;
        }
        .review-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(340px, 1fr));
            gap: 2rem;
        }
        .review-item {
            background: white;
            padding: 2rem 1.5rem;
            border-radius: 18px;
            box-shadow: 0 4px 24px rgba(0,0,0,0.08);
            border: 1px solid #e5e7eb;
            border-left: 5px solid #fbbf24;
            display: flex;
            flex-direction: column;
            gap: 1rem;
            transition: all 0.3s ease;
        }
        
        .review-item.approved {
            border-left-color: #10b981;
        }
        
        .review-item.pending {
            border-left-color: #f59e0b;
        }
        
        .review-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 32px rgba(0,0,0,0.12);
        }
        .review-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .review-actions {
            display: flex;
            gap: 0.5rem;
        }
        .btn-approve {
            background: #10b981;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 600;
            box-shadow: 0 2px 8px rgba(16,185,129,0.08);
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .btn-approve:hover:not(:disabled) {
            background: #059669;
            transform: translateY(-1px);
        }
        .btn-approve:disabled {
            cursor: not-allowed;
            opacity: 0.7;
        }
        .review-item.approved .btn-approve {
            background: #f59e0b;
        }
        .review-item.approved .btn-approve:hover {
            background: #d97706;
        }
        .btn-delete {
            background: #ef4444;
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            box-shadow: 0 2px 8px rgba(239,68,68,0.08);
            transition: background 0.2s;
        }
        .btn-delete:hover:not(:disabled) {
            background: #dc2626;
        }
        .status-badge {
            padding: 0.4rem 1rem;
            border-radius: 20px;
            font-size: 0.95rem;
            font-weight: 600;
        }
        .status-approved {
            background: #d1fae5;
            color: #065f46;
        }
        .status-pending {
            background: #fef3c7;
            color: #92400e;
        }
        .loading {
            text-align: center;
            padding: 2rem;
            color: #6366f1;
            font-size: 1.2rem;
            font-weight: 500;
        }
        .error {
            background: #fee2e2;
            color: #dc2626;
            padding: 1rem;
            border-radius: 12px;
            margin-bottom: 1rem;
            font-size: 1.1rem;
        }
        .admin-notification {
            position: fixed;
            top: 24px;
            right: 24px;
            background: #6366f1;
            color: white;
            padding: 1.2rem 2rem;
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(99,102,241,0.18);
            z-index: 10000;
            max-width: 350px;
            font-weight: 600;
            font-size: 1.1rem;
            border-left: 5px solid #10b981;
        }
        .login-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #e0e7ff 0%, #f8fafc 100%);
            padding: 1rem;
        }
        
        .login-box {
            background: white;
            padding: 2rem;
            border-radius: 18px;
            box-shadow: 0 4px 24px rgba(0,0,0,0.1);
            width: 100%;
            max-width: 400px;
        }
        
        .login-box h2 {
            text-align: center;
            margin-bottom: 2rem;
            color: #1f2937;
        }
        
        .btn-login {
            width: 100%;
            padding: 0.75rem;
            background: #6366f1;
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .btn-login:hover {
            background: #4f46e5;
        }
        
        #adminPassword {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 10px;
            margin-bottom: 1rem;
            font-size: 1rem;
        }
        
        #loginError {
            background: #fee2e2;
            color: #dc2626;
            padding: 0.75rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            text-align: center;
            font-size: 0.9rem;
        }

        @media (max-width: 700px) {
            .admin-container { padding: 0.5rem; }
            .review-list { grid-template-columns: 1fr; }
            .admin-header { padding: 1rem; }
            .login-box { margin: 1rem; }
        }
    </style>
</head>
<body>
    <div id="login-container" class="login-container">
        <div class="login-box">
            <h2><i class="fas fa-lock"></i> Admin Girişi</h2>
            <form id="loginForm" onsubmit="handleLogin(event)">
                <div class="form-group">
                    <input type="password" id="adminPassword" placeholder="Admin şifrenizi girin" required>
                </div>
                <div id="loginError" class="error" style="display: none;">
                    Hatalı şifre! Tekrar deneyin.
                </div>
                <button type="submit" class="btn-login">Giriş Yap</button>
            </form>
        </div>
    </div>
    <div id="admin-container" class="admin-container" style="display: none;">
        <div class="admin-header">
            <h1><i class="fas fa-cog"></i> Nebesu Temizlik Admin Panel</h1>
            <p>Yorumları ve iletişim taleplerini yönetin</p>
        </div>
        <div class="admin-tabs">
            <button class="admin-tab active" onclick="showTab('reviews')">
                <i class="fas fa-comments"></i> Yorumlar
            </button>
            <button class="admin-tab" onclick="showTab('contacts')">
                <i class="fas fa-envelope"></i> İletişim Talepleri
            </button>
        </div>
        <div id="reviews-content" class="admin-content active">
            <h2 style="margin-bottom:1.5rem;">Müşteri Yorumları</h2>
            <div class="reviews-filters">
                <select id="statusFilter" onchange="filterReviews()">
                    <option value="all">Tüm Yorumlar</option>
                </select>
                <input type="text" id="searchFilter" placeholder="Yorum ara..." onkeyup="filterReviews()">
                <button onclick="refreshReviews()">
                    <i class="fas fa-sync-alt"></i> Yenile
                </button>
            </div>
            <div id="reviews-list" class="review-list loading">
                Yorumlar yükleniyor...
            </div>
        </div>
        <div id="contacts-content" class="admin-content">
            <h2 style="margin-bottom:1.5rem;">İletişim Talepleri</h2>
            <div class="reviews-filters">
                <select id="contactStatusFilter" onchange="filterContacts()">
                    <option value="all">Tüm Talepler</option>
                    <option value="processed">İşlenenler</option>
                    <option value="pending">Bekleyenler</option>
                </select>
                <input type="text" id="contactSearchFilter" placeholder="Talep ara..." onkeyup="filterContacts()">
                <button onclick="loadContacts()">
                    <i class="fas fa-sync-alt"></i> Yenile
                </button>
            </div>
            <div id="contacts-list" class="review-list loading">
                Talepler yükleniyor...
            </div>
        </div>
    </div>
    <script>
        const API_BASE = '/api';
        const ADMIN_PASSWORD = 'nebesu2024'; // Admin şifresi
        let allReviews = []; // Store all reviews for filtering
        let isLoggedIn = false;
        
        // Check login status on page load
        function initializeLogin() {
            const loginStatus = localStorage.getItem('admin_login_status');
            if (loginStatus === 'true') {
                isLoggedIn = true;
                showAdminPanel();
            }
        }
        
        // Show admin panel
        function showAdminPanel() {
            document.getElementById('login-container').style.display = 'none';
            document.getElementById('admin-container').style.display = 'block';
            loadReviews();
        }
        
        // Show login form
        function showLoginForm() {
            document.getElementById('login-container').style.display = 'flex';
            document.getElementById('admin-container').style.display = 'none';
        }
        
        // Tab switching
        function showTab(tabName) {
            // Hide all content
            document.querySelectorAll('.admin-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // Remove active class from all tabs
            document.querySelectorAll('.admin-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show selected content
            document.getElementById(tabName + '-content').classList.add('active');
            
            // Add active class to clicked tab
            event.target.classList.add('active');
            
            // Load data for the tab
            if (tabName === 'reviews') {
                loadReviews();
            } else if (tabName === 'contacts') {
                loadContacts();
            }
        }
        
        let isLoading = false;
        
        // Load reviews
        async function loadReviews() {
            if (isLoading) return; // Eğer yükleme devam ediyorsa yeni istek yapma
            
            const reviewsList = document.getElementById('reviews-list');
            isLoading = true;
            reviewsList.innerHTML = '<div class="loading">Yorumlar yükleniyor...</div>';
            
            try {
                const response = await fetch(`${API_BASE}/admin/reviews`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('admin_token')}` // Token ekleyelim
                    },
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const reviews = await response.json();
                allReviews = reviews; // Store all reviews
                displayReviews(reviews);
                
            } catch (error) {
                console.error('Error loading reviews:', error);
                reviewsList.innerHTML = 
                    '<div class="error"><i class="fas fa-exclamation-triangle"></i> Yorumlar yüklenirken hata oluştu. Lütfen sayfayı yenileyin.</div>';
                
                if (error.message.includes('401')) {
                    // Eğer yetkilendirme hatası varsa logout yapalım
                    logout();
                }
            } finally {
                isLoading = false; // Her durumda loading durumunu sıfırla
            }
        }
        
        // Display reviews
        function displayReviews(reviews) {
            const reviewsList = document.getElementById('reviews-list');
            if (reviews.length === 0) {
                reviewsList.innerHTML = '<p>Henüz yorum bulunmuyor.</p>';
                return;
            }
            reviewsList.classList.remove('loading'); // Yükleniyor stilini kaldır
            reviewsList.innerHTML = reviews.map(function(review) {
                return `
                    <div class="review-item">
                        <div class="review-header">
                            <div>
                                <strong>${review.name}</strong>
                            </div>
                            <div class="review-actions">
                                <button class="btn-delete" onclick="deleteReview(${review.id}, this)">
                                    <i class="fas fa-trash"></i> Yorumu Sil
                                </button>
                            </div>
                        </div>
                        <div class="review-details">
                            <p><strong>Hizmet:</strong> ${getServiceDisplayName(review.service)}</p>
                            <p><strong>Puan:</strong> ${generateStars(review.rating)}</p>
                            <p><strong>Yorum:</strong> ${review.text}</p>
                            <p><strong>Tarih:</strong> ${formatDate(review.created_at)}</p>
                            ${review.email ? `<p><strong>E-posta:</strong> ${review.email}</p>` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // Refresh reviews
        function refreshReviews() {
            loadReviews();
        }
        
        // Filter reviews
        function filterReviews() {
            const statusFilter = document.getElementById('statusFilter').value;
            const searchFilter = document.getElementById('searchFilter').value.toLowerCase();
            
            let filteredReviews = allReviews;
            
            // Filter by status
            if (statusFilter === 'approved') {
                filteredReviews = filteredReviews.filter(review => review.is_approved);
            } else if (statusFilter === 'pending') {
                filteredReviews = filteredReviews.filter(review => !review.is_approved);
            }
            
            // Filter by search text
            if (searchFilter) {
                filteredReviews = filteredReviews.filter(review => 
                    review.name.toLowerCase().includes(searchFilter) ||
                    review.text.toLowerCase().includes(searchFilter) ||
                    getServiceDisplayName(review.service).toLowerCase().includes(searchFilter)
                );
            }
            
            displayReviews(filteredReviews);
        }
        
        // Load contacts
        async function loadContacts() {
            if (isLoading) return; // Eğer yükleme devam ediyorsa yeni istek yapma
            
            const contactsList = document.getElementById('contacts-list');
            isLoading = true;
            contactsList.innerHTML = '<div class="loading">Talepler yükleniyor...</div>';
            
            try {
                const response = await fetch(`${API_BASE}/admin/contact-requests`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('admin_token')}`
                    },
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const contacts = await response.json();
                allContacts = contacts; // Store all contacts for filtering
                
                if (contacts.length === 0) {
                    contactsList.innerHTML = '<p>Henüz iletişim talebi bulunmuyor.</p>';
                    isLoading = false;
                    return;
                }
                
                contactsList.classList.remove('loading');
                contactsList.innerHTML = contacts.map(contact => `
                    <div class="review-item ${contact.is_processed ? 'approved' : 'pending'}">
                        <div class="review-header">
                            <div>
                                <strong>${contact.name}</strong>
                                <span class="status-badge ${contact.is_processed ? 'status-approved' : 'status-pending'}">
                                    ${contact.is_processed ? 'İşlendi' : 'Beklemede'}
                                </span>
                            </div>
                            <div class="review-actions">
                                <a href="tel:${contact.phone}" class="btn-approve" style="text-decoration: none; margin-right: 5px;">
                                    <i class="fas fa-phone"></i> Ara
                                </a>
                                <a href="https://wa.me/90${contact.phone.replace(/\D/g, '')}" target="_blank" class="btn-approve" style="text-decoration: none; margin-right: 5px;">
                                    <i class="fab fa-whatsapp"></i> WhatsApp
                                </a>
                                <button class="btn-approve" onclick="toggleContactStatus(${contact.id}, this, ${contact.is_processed})" style="margin-right: 5px;">
                                    ${contact.is_processed ? '<i class="fas fa-times"></i> İşlendi' : '<i class="fas fa-check"></i> İşle'}
                                </button>
                                <button class="btn-delete" onclick="deleteContact(${contact.id}, this)">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                        <div class="contact-details">
                            <p><strong>Telefon:</strong> ${contact.phone}</p>
                            <p><strong>Hizmet:</strong> ${getServiceDisplayName(contact.service)}</p>
                            <p><strong>Tarih:</strong> ${formatDate(contact.created_at)}</p>
                            ${contact.message ? `<p><strong>Mesaj:</strong> ${contact.message}</p>` : ''}
                        </div>
                    </div>
                `).join('');
                
            } catch (error) {
                console.error('Error loading contacts:', error);
                contactsList.innerHTML = 
                    '<div class="error"><i class="fas fa-exclamation-triangle"></i> İletişim talepleri yüklenirken hata oluştu. Lütfen sayfayı yenileyin.</div>';
                
                if (error.message.includes('401')) {
                    logout();
                }
            } finally {
                isLoading = false; // Her durumda loading durumunu sıfırla
            }
        }
        
        // Approve review
        async function toggleReviewApproval(reviewId, button, currentStatus) {
            const originalContent = button.innerHTML;
            button.disabled = true;
            button.innerHTML = 'İşleniyor...';
            button.style.background = '#9ca3af';

            const endpoint = currentStatus
                ? `${API_BASE}/admin/reviews/${reviewId}/unapprove`
                : `${API_BASE}/admin/reviews/${reviewId}/approve`;

            try {
                const response = await fetch(endpoint, {
                    method: 'PATCH',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('admin_token')}`
                    }
                });

                if (!response.ok) {
                    throw new Error('Sunucu hatası');
                }

                showNotification(
                    currentStatus 
                        ? '⚠️ Yorum onayı kaldırıldı!'
                        : '✅ Yorum onaylandı!',
                    'success'
                );

                // Yorumları yeniden yükle
                loadReviews();

                // Butonu normal haline getir
                button.disabled = false;
                button.style.background = currentStatus ? '#ef4444' : '#10b981';
                button.innerHTML = currentStatus
                    ? '<i class="fas fa-check"></i> Onayla'
                    : '<i class="fas fa-times"></i> Onayı Kaldır';
            } catch (error) {
                console.error('Toggle review error:', error);
                showNotification('❌ İşlem sırasında hata oluştu.', 'error');
                button.innerHTML = originalContent;
                button.disabled = false;
                button.style.background = currentStatus ? '#10b981' : '#ef4444';
            }
        }        // Delete review
        async function deleteReview(reviewId, button) {
            if (!confirm('⚠️ UYARI: Bu yorumu kalıcı olarak silmek istediğinizden emin misiniz?\n\nBu işlem geri alınamaz!')) {
                return;
            }
            
            const originalContent = button.innerHTML;
            button.disabled = true;
            button.innerHTML = 'Siliniyor...';
            button.style.background = '#9ca3af';
            
            try {
                const response = await fetch(`${API_BASE}/admin/reviews/${reviewId}`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('admin_token')}`
                    },
                });
                
                if (response.ok) {
                    // Success state
                    button.innerHTML = '<i class="fas fa-check-circle"></i> Silindi!';
                    button.style.background = '#10b981';
                    
                    showNotification('✅ Yorum başarıyla silindi!', 'success');
                    
                    // Reload reviews after deletion
                    setTimeout(() => {
                        loadReviews();
                    }, 1500);
                } else {
                    // Error state
                    button.innerHTML = '<i class="fas fa-exclamation-circle"></i> Hata!';
                    button.style.background = '#ef4444';
                    
                    showNotification('❌ Yorum silinirken hata oluştu.', 'error');
                    
                    // Reset button after error
                    setTimeout(() => {
                        button.innerHTML = originalContent;
                        button.style.background = '#ef4444';
                        button.disabled = false;
                    }, 2000);
                }
            } catch (error) {
                console.error('Error deleting review:', error);
                
                // Error state
                button.innerHTML = '<i class="fas fa-exclamation-circle"></i> Hata!';
                button.style.background = '#ef4444';
                
                showNotification('❌ Yorum silinirken hata oluştu.', 'error');
                
                // Reset button after error
                setTimeout(() => {
                    button.innerHTML = originalContent;
                    button.style.background = '#ef4444';
                    button.disabled = false;
                }, 2000);
            }
        }
        
        // Store all contacts for filtering
        let allContacts = [];

        // Filter contacts
        function filterContacts() {
            const statusFilter = document.getElementById('contactStatusFilter').value;
            const searchFilter = document.getElementById('contactSearchFilter').value.toLowerCase();
            
            let filteredContacts = allContacts;
            
            // Filter by status
            if (statusFilter === 'processed') {
                filteredContacts = filteredContacts.filter(contact => contact.is_processed);
            } else if (statusFilter === 'pending') {
                filteredContacts = filteredContacts.filter(contact => !contact.is_processed);
            }
            
            // Filter by search text
            if (searchFilter) {
                filteredContacts = filteredContacts.filter(contact => 
                    contact.name.toLowerCase().includes(searchFilter) ||
                    contact.phone.toLowerCase().includes(searchFilter) ||
                    (contact.message && contact.message.toLowerCase().includes(searchFilter)) ||
                    getServiceDisplayName(contact.service).toLowerCase().includes(searchFilter)
                );
            }
            
            displayContacts(filteredContacts);
        }

        // Display contacts
        function displayContacts(contacts) {
            const contactsList = document.getElementById('contacts-list');
            if (contacts.length === 0) {
                contactsList.innerHTML = '<p>Henüz iletişim talebi bulunmuyor.</p>';
                return;
            }

            contactsList.classList.remove('loading');
            contactsList.innerHTML = contacts.map(contact => `
                <div class="review-item ${contact.is_processed ? 'approved' : 'pending'}">
                    <div class="review-header">
                        <div>
                            <strong>${contact.name}</strong>
                            <span class="status-badge ${contact.is_processed ? 'status-approved' : 'status-pending'}">
                                ${contact.is_processed ? 'İşlendi' : 'Beklemede'}
                            </span>
                        </div>
                        <div class="review-actions">
                            <a href="tel:${contact.phone}" class="btn-approve" style="text-decoration: none; margin-right: 5px;">
                                <i class="fas fa-phone"></i> Ara
                            </a>
                            <a href="https://wa.me/90${contact.phone.replace(/\D/g, '')}" target="_blank" class="btn-approve" style="text-decoration: none; margin-right: 5px;">
                                <i class="fab fa-whatsapp"></i> WhatsApp
                            </a>
                            <button class="btn-approve" onclick="toggleContactStatus(${contact.id}, this, ${contact.is_processed})" style="margin-right: 5px;">
                                ${contact.is_processed ? '<i class="fas fa-times"></i> İşlendi' : '<i class="fas fa-check"></i> İşle'}
                            </button>
                            <button class="btn-delete" onclick="deleteContact(${contact.id}, this)">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                    <div class="contact-details">
                        <p><strong>Telefon:</strong> ${contact.phone}</p>
                        <p><strong>Hizmet:</strong> ${getServiceDisplayName(contact.service)}</p>
                        <p><strong>Tarih:</strong> ${formatDate(contact.created_at)}</p>
                        ${contact.message ? `<p><strong>Mesaj:</strong> ${contact.message}</p>` : ''}
                    </div>
                </div>
            `).join('');
        }

        // Toggle contact status
        async function toggleContactStatus(contactId, button, currentStatus) {
            const originalContent = button.innerHTML;
            button.disabled = true;
            button.innerHTML = 'İşleniyor...';
            button.style.background = '#9ca3af';

            const endpoint = currentStatus
                ? `${API_BASE}/admin/contact-requests/${contactId}/unprocess`
                : `${API_BASE}/admin/contact-requests/${contactId}/process`;

            try {
                const response = await fetch(endpoint, {
                    method: 'PATCH',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('admin_token')}`
                    }
                });

                if (response.ok) {
                    showNotification(
                        currentStatus 
                            ? '⚠️ İşlenmemiş olarak işaretlendi!' 
                            : '✅ İşlendi olarak işaretlendi!',
                        'success'
                    );
                    loadContacts();
                } else {
                    throw new Error('Sunucu hatası');
                }
            } catch (error) {
                console.error('Toggle contact status error:', error);
                showNotification('❌ İşlem sırasında hata oluştu.', 'error');
                button.innerHTML = originalContent;
                button.disabled = false;
                button.style.background = currentStatus ? '#10b981' : '#ef4444';
            }
        }

        // Delete contact
        async function deleteContact(contactId, button) {
            if (!confirm('⚠️ UYARI: Bu iletişim talebini kalıcı olarak silmek istediğinizden emin misiniz?\n\nBu işlem geri alınamaz!')) {
                return;
            }
            
            const originalContent = button.innerHTML;
            button.disabled = true;
            button.innerHTML = 'Siliniyor...';
            button.style.background = '#9ca3af';
            
            try {
                const response = await fetch(`${API_BASE}/admin/contact-requests/${contactId}`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('admin_token')}`
                    },
                });
                
                if (response.ok) {
                    button.innerHTML = '<i class="fas fa-check-circle"></i> Silindi!';
                    button.style.background = '#10b981';
                    showNotification('✅ İletişim talebi başarıyla silindi!', 'success');
                    setTimeout(() => {
                        loadContacts();
                    }, 1500);
                } else {
                    throw new Error('Sunucu hatası');
                }
            } catch (error) {
                console.error('Error deleting contact:', error);
                button.innerHTML = '<i class="fas fa-exclamation-circle"></i> Hata!';
                button.style.background = '#ef4444';
                showNotification('❌ İletişim talebi silinirken hata oluştu.', 'error');
                setTimeout(() => {
                    button.innerHTML = originalContent;
                    button.style.background = '#ef4444';
                    button.disabled = false;
                }, 2000);
            }
        }

        // Utility functions
        function getServiceDisplayName(service) {
            const serviceMap = {
                'ev-temizligi': 'Ev Temizliği',
                'ofis-temizligi': 'Ofis Temizliği',
                'apartman-temizligi': 'Apartman Temizliği',
                'insaat-sonrasi': 'İnşaat Sonrası Temizlik',
                'villa-temizligi': 'Villa Temizliği',
                'merdiven-temizligi': 'Merdiven Temizliği',
                'zemin-cilalama': 'Zemin Cilalama ve Temizliği',
                'yat-temizligi': 'Yat Temizliği'
            };
            return serviceMap[service] || service;
        }
        
        function generateStars(rating) {
            let stars = '';
            for (let i = 1; i <= 5; i++) {
                if (i <= rating) {
                    stars += '<i class="fas fa-star" style="color: #fbbf24;"></i>';
                } else {
                    stars += '<i class="far fa-star" style="color: #d1d5db;"></i>';
                }
            }
            return stars;
        }
        
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('tr-TR', {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }
        
        function showNotification(message, type) {
            // Remove existing notifications
            const existingNotifications = document.querySelectorAll('.admin-notification');
            existingNotifications.forEach(notif => notif.remove());
            
            const notification = document.createElement('div');
            notification.className = 'admin-notification';
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${type === 'success' ? '#10b981' : '#ef4444'};
                color: white;
                padding: 1rem 1.5rem;
                border-radius: 12px;
                box-shadow: 0 8px 32px rgba(0,0,0,0.2);
                z-index: 10000;
                max-width: 350px;
                font-weight: 600;
                animation: slideIn 0.3s ease-out;
                border-left: 4px solid ${type === 'success' ? '#059669' : '#dc2626'};
            `;
            
            // Add slide-in animation
            const style = document.createElement('style');
            style.textContent = `
                @keyframes slideIn {
                    from {
                        transform: translateX(100%);
                        opacity: 0;
                    }
                    to {
                        transform: translateX(0);
                        opacity: 1;
                    }
                }
                @keyframes slideOut {
                    from {
                        transform: translateX(0);
                        opacity: 1;
                    }
                    to {
                        transform: translateX(100%);
                        opacity: 0;
                    }
                }
            `;
            document.head.appendChild(style);
            
            notification.textContent = message;
            document.body.appendChild(notification);
            
            // Auto remove with slide-out animation
            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease-in';
                setTimeout(() => {
                    notification.remove();
                }, 300);
            }, 4000);
        }
        
        // Login functionality
        async function handleLogin(e) {
            e.preventDefault();
            const password = document.getElementById('adminPassword').value;
            const errorDiv = document.getElementById('loginError');
            
            try {
                const response = await fetch(`${API_BASE}/admin/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ password })
                });

                if (response.ok) {
                    const data = await response.json();
                    localStorage.setItem('admin_token', data.token);
                    localStorage.setItem('admin_login_status', 'true');
                    isLoggedIn = true;
                    showAdminPanel();
                    document.getElementById('adminPassword').value = '';
                } else {
                    throw new Error('Giriş başarısız');
                }
            } catch (error) {
                console.error('Login error:', error);
                errorDiv.style.display = 'block';
                document.getElementById('adminPassword').value = '';
                setTimeout(() => {
                    errorDiv.style.display = 'none';
                }, 3000);
            }
        }
        
        // Logout functionality
        function logout() {
            if (confirm('Admin panelinden çıkmak istediğinizden emin misiniz?')) {
                isLoggedIn = false;
                localStorage.removeItem('admin_login_status');
                localStorage.removeItem('admin_token');
                showLoginForm();
                document.getElementById('adminPassword').value = '';
                // Reset tabs to default
                document.querySelectorAll('.admin-tab').forEach(tab => {
                    tab.classList.remove('active');
                });
                document.querySelectorAll('.admin-content').forEach(content => {
                    content.classList.remove('active');
                });
                document.querySelector('.admin-tab').classList.add('active');
                document.getElementById('reviews-content').classList.add('active');
            }
        }
        
        // Load initial data
        document.addEventListener('DOMContentLoaded', function() {
            // Setup login form
            document.getElementById('loginForm').addEventListener('submit', handleLogin);
            
            // Initialize login status
            initializeLogin();
        });
    
    </script>
</body>
</html>